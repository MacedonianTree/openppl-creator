#!/usr/bin/env python3
import os
import sys
import logging

import openppl_creator_lib
from openppl_creator_lib import read_files
from openppl_creator_lib import hands
from openppl_creator_lib import configuration
from openppl_creator_lib import cfg

import argparse

parser = argparse.ArgumentParser(description=openppl_creator_lib.DESCRIPTION)

for debug_arg in ['-d', '--debug']:
    parser.add_argument(debug_arg, dest='debug', action='store_true', help='Set logging level to DEBUG.')
for write_config_arg in ['-c', '--config']:
    parser.add_argument(write_config_arg, dest='write_config', action='store_true', help='Write default config yaml file.')


if __name__ == '__main__':
    args = parser.parse_args()
    if args.debug:
        logging.root.setLevel(logging.DEBUG)

    current_path = os.getcwd()

    if args.write_config:
        configuration.write_config(current_path)
        sys.exit()

    abs_input_path = os.path.join(current_path, cfg['input_path'])

    oppl_files = read_files.get_oppl_files(abs_input_path)

    if cfg['hand_list_file_name'] in oppl_files:
        oppl_files[cfg['hand_list_file_name']] = hands.expand_hands(oppl_files[cfg['hand_list_file_name']])

    abs_output_path = os.path.join(current_path, cfg['output_path'])

    if not os.path.exists(abs_output_path):
        os.makedirs(abs_output_path)

    scripts = [script for function, script in oppl_files.items()]
    separator = "\n"
    final_script = separator.join( scripts)

    logging.info("Creating final file: %s", cfg['output_file_name'])
    with open(os.path.join(abs_output_path, cfg['output_file_name']), 'w') as output_file:
        output_file.write(final_script)

    logging.info("Completed!")
